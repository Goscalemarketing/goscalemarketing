<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pruebas · AR</title>

  <!-- Preview estable -->
  <script type="module" src="https://unpkg.com/@google/model-viewer@4.1.0/dist/model-viewer.min.js"></script>

  <style>
    html, body{
      margin:0;
      height:100%;
      background:#0b0b0b;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      color:#fff;
      overflow:hidden;
    }

    header{
      position:fixed;
      inset:0 0 auto 0;
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px;
      background:rgba(15,15,15,.75);
      backdrop-filter: blur(10px);
      z-index:30;
    }

    .menuBtn{
      color:#fff;
      text-decoration:none;
      border:1px solid rgba(255,255,255,.18);
      border-radius:10px;
      padding:8px 12px;
      font-size:14px;
      font-weight:700;
    }

    .byGoscale{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.16);
      text-decoration:none;
      color:#fff;
      font-size:12px;
      font-weight:700;
    }
    .byGoscale img{ height:22px; width:auto; }

    main{
      position:fixed;
      inset:56px 0 0 0;
      display:flex;
      flex-direction:column;
    }

    #dishInfo{
      padding:14px 16px 10px;
      background:linear-gradient(
        to bottom,
        rgba(11,11,11,.95),
        rgba(11,11,11,.75),
        rgba(11,11,11,0)
      );
      z-index:10;
    }
    #dishTitle{ margin:0; font-size:24px; font-weight:900; }
    #dishDesc{ margin:8px 0 0; font-size:14px; color:rgba(255,255,255,.75); max-width:520px; line-height:1.45; }

    .viewerWrap{
      position:relative;
      flex:1;
      min-height:0;
    }

    /* PREVIEW */
    model-viewer{
      width:100%;
      height:100%;
      background:#0b0b0b;
      display:block;
      touch-action: pan-y;
    }

    /* Botón AR (nuestro) */
    .arBtn{
      position:absolute;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      padding:14px 26px;
      border-radius:18px;
      font-size:16px;
      font-weight:900;
      background:#fff;
      color:#111;
      border:0;
      box-shadow:0 12px 30px rgba(0,0,0,.45);
      cursor:pointer;
      z-index:25;
    }

    .arBtn[disabled]{ opacity:.55; cursor:not-allowed; }

    /* Loader preview */
    #loading{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:14px;
      background:rgba(0,0,0,.75);
      z-index:24;
    }
    .spinner{
      width:44px;
      height:44px;
      border:4px solid rgba(255,255,255,.2);
      border-top:4px solid #fff;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* WebXR canvas overlay (solo cuando entras en AR) */
    #xrCanvas{
      position:fixed;
      inset:0;
      z-index:999; /* por encima de todo */
      display:none; /* se activa al entrar en AR */
      touch-action:none;
    }

    #status{
      position:fixed;
      left:10px;
      bottom:10px;
      z-index:1000;
      font-size:12px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.45);
      max-width:75vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.9;
      display:none;
    }
  </style>
</head>

<body>

<header>
  <a class="menuBtn" href="https://www.canva.com/design/DAG9pcht0YQ/vMlVejQnQ2StmRcQqudt3Q/view?utm_content=DAG9pcht0YQ&utm_campaign=designshare&utm_medium=link2&utm_source=uniquelinks&utlId=h0d5e8121fb">
    ← Menú
  </a>

  <a class="byGoscale" href="https://goscalemarketing.com" target="_blank" rel="noopener">
    <span>by</span>
    <img src="https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/assets/logo/goscalemarketing-logo.png">
  </a>
</header>

<main id="uiMain">
  <section id="dishInfo">
    <h1 id="dishTitle">Pruebas</h1>
    <p id="dishDesc">Ingredientes: Es un elemento de pruebas.</p>
  </section>

  <div class="viewerWrap">
    <div id="loading">
      <div class="spinner"></div>
      <p>Cargando modelo…</p>
    </div>

    <!-- PREVIEW: model-viewer (estable) -->
    <model-viewer
      id="mvPreview"
      src="https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pruebas/Pruebas.glb"
      ios-src="https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pruebas/Pruebas.usdz"

      camera-controls
      interaction-prompt="none"
      loading="eager"
      reveal="auto"

      environment-image="https://modelviewer.dev/shared-assets/environments/neutral.hdr"
      tone-mapping="neutral"
      exposure="1.6"
      shadow-intensity="1"

      ar
      ar-modes="scene-viewer quick-look"
      ar-placement="floor"
      ar-scale="auto"
      ar-light-estimation
    ></model-viewer>

    <!-- Botón que nosotros controlamos -->
    <button id="startAR" class="arBtn" disabled>Ver en AR (WebXR test)</button>
  </div>
</main>

<canvas id="xrCanvas"></canvas>
<div id="status">Iniciando…</div>

<script type="module">
  // ===== URLs (las mismas que ya usas) =====
  const GLB_URL  = "https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pruebas/Pruebas.glb";
  const USDZ_URL = "https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pruebas/Pruebas.usdz";

  const ua = navigator.userAgent;
  const isiOS = /iPad|iPhone|iPod/.test(ua);

  const mvPreview = document.getElementById('mvPreview');
  const startBtn = document.getElementById('startAR');
  const loading = document.getElementById('loading');

  const uiMain = document.getElementById('uiMain');
  const xrCanvas = document.getElementById('xrCanvas');
  const statusEl = document.getElementById('status');
  const setStatus = (t) => { statusEl.style.display = "block"; statusEl.textContent = t; };

  function openSceneViewer() {
    const intent =
      "intent://arvr.google.com/scene-viewer/1.0" +
      "?file=" + encodeURIComponent(GLB_URL) +
      "&mode=ar_preferred" +
      "&resizable=true" +
      "#Intent;scheme=https;package=com.google.android.googlequicksearchbox;end;";
    window.location.href = intent;
  }

  // Preview listo
  mvPreview.addEventListener('load', () => {
    loading.style.display = 'none';
    startBtn.disabled = false;
  });

  mvPreview.addEventListener('error', () => {
    loading.querySelector('p').textContent = 'Error cargando el modelo';
  });

  // ===== WebXR custom (solo al pulsar el botón) =====
  import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
  import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js";

  let renderer, scene, camera, controller;
  let modelRoot = null;
  let placed = false;
  let hitTestSource = null;
  let hitTestRequested = false;

  // Reticle
  let reticle;

  // Gestos
  const pointers = new Map();
  let startDist = 0, startAngle = 0, startScale = 1, startYaw = 0;

  function getTwo() { return Array.from(pointers.values()).slice(0, 2); }
  function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
  function angle(a,b){ return Math.atan2(b.y-a.y, b.x-a.x); }

  function getYawRad() {
    if (!modelRoot) return 0;
    const e = new THREE.Euler().setFromQuaternion(modelRoot.quaternion, "YXZ");
    return e.y;
  }
  function setYawRad(yaw) {
    if (!modelRoot) return;
    const e = new THREE.Euler(0, yaw, 0, "YXZ");
    modelRoot.quaternion.setFromEuler(e);
  }

  function bindGestures() {
    xrCanvas.style.touchAction = "none";

    xrCanvas.addEventListener("pointerdown", (e) => {
      pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });
      if (pointers.size === 2 && placed && modelRoot){
        const [p1,p2] = getTwo();
        startDist = dist(p1,p2);
        startAngle = angle(p1,p2);
        startScale = modelRoot.scale.x;
        startYaw = getYawRad();
      }
    }, { passive:false });

    xrCanvas.addEventListener("pointermove", (e) => {
      if (!pointers.has(e.pointerId)) return;
      pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });

      if (pointers.size === 2 && placed && modelRoot){
        e.preventDefault();
        const [p1,p2] = getTwo();
        const d = dist(p1,p2);
        const a = angle(p1,p2);

        if (startDist > 0){
          const factor = d / startDist;
          const newScale = THREE.MathUtils.clamp(startScale * factor, 0.2, 3.0);
          modelRoot.scale.setScalar(newScale);
        }

        const delta = a - startAngle;
        setYawRad(startYaw + delta);
      }
    }, { passive:false });

    const up = (e) => {
      pointers.delete(e.pointerId);
      if (pointers.size < 2){ startDist = 0; startAngle = 0; }
    };
    xrCanvas.addEventListener("pointerup", up, { passive:true });
    xrCanvas.addEventListener("pointercancel", up, { passive:true });
  }

  async function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera();

    renderer = new THREE.WebGLRenderer({ canvas: xrCanvas, antialias:true, alpha:true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;

    scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.0));

    reticle = new THREE.Mesh(
      new THREE.RingGeometry(0.08, 0.10, 32).rotateX(-Math.PI/2),
      new THREE.MeshBasicMaterial({ color: 0xffffff, transparent:true, opacity:0.9 })
    );
    reticle.matrixAutoUpdate = false;
    reticle.visible = false;
    scene.add(reticle);

    controller = renderer.xr.getController(0);
    scene.add(controller);

    controller.addEventListener("select", () => {
      if (!reticle.visible || !modelRoot) return;
      modelRoot.visible = true;
      modelRoot.position.setFromMatrixPosition(reticle.matrix);

      const rot = new THREE.Quaternion().setFromRotationMatrix(reticle.matrix);
      modelRoot.quaternion.copy(rot);

      placed = true;
      setStatus("Colocado. Pinch=tamaño · Giro 2 dedos=rotación.");
    });

    // Carga modelo
    setStatus("Cargando modelo AR…");
    const loader = new GLTFLoader();
    modelRoot = await new Promise((resolve, reject) => {
      loader.load(GLB_URL, (gltf) => resolve(gltf.scene), undefined, reject);
    });
    modelRoot.visible = false;
    modelRoot.scale.setScalar(1);
    scene.add(modelRoot);

    bindGestures();

    renderer.setAnimationLoop((t, frame) => {
      if (frame){
        const refSpace = renderer.xr.getReferenceSpace();

        if (!hitTestRequested){
          const session = renderer.xr.getSession();
          session.requestReferenceSpace("viewer").then((viewerSpace) => {
            session.requestHitTestSource({ space: viewerSpace }).then((src) => hitTestSource = src);
          });

          session.addEventListener("end", () => {
            // Volver a UI
            xrCanvas.style.display = "none";
            uiMain.style.display = "flex";
            statusEl.style.display = "none";

            hitTestRequested = false;
            hitTestSource = null;
            reticle.visible = false;
            placed = false;
            if (modelRoot) modelRoot.visible = false;
          });

          hitTestRequested = true;
        }

        if (hitTestSource){
          const hits = frame.getHitTestResults(hitTestSource);
          if (hits.length){
            const pose = hits[0].getPose(refSpace);
            reticle.visible = true;
            reticle.matrix.fromArray(pose.transform.matrix);
          } else {
            reticle.visible = false;
          }
        }
      }

      renderer.render(scene, camera);
    });
  }

  async function startWebXR() {
    // iOS: Quick Look (sin tocarlo)
    if (isiOS) {
      window.location.href = USDZ_URL;
      return;
    }

    // Android: WebXR si existe, si no, Scene Viewer
    if (!navigator.xr || !window.isSecureContext) {
      openSceneViewer();
      return;
    }

    const ok = await navigator.xr.isSessionSupported("immersive-ar").catch(() => false);
    if (!ok) {
      openSceneViewer();
      return;
    }

    // Oculta UI y muestra canvas
    uiMain.style.display = "none";
    xrCanvas.style.display = "block";
    setStatus("Iniciando WebXR AR…");

    if (!renderer) {
      try {
        await initThree();
      } catch (e) {
        console.error(e);
        setStatus("Error WebXR. Abriendo Scene Viewer…");
        openSceneViewer();
        return;
      }
    }

    const session = await navigator.xr.requestSession("immersive-ar", {
      requiredFeatures: ["hit-test"],
      optionalFeatures: ["dom-overlay"],
      domOverlay: { root: document.body }
    });

    await renderer.xr.setSession(session);
    setStatus("Apunta al suelo hasta ver el círculo.");
  }

  startBtn.addEventListener("click", startWebXR);

  window.addEventListener("resize", () => {
    if (renderer) renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>

</body>
</html>
