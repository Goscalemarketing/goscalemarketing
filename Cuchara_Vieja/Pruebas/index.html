<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pruebas · AR (WebXR)</title>

  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:#fff; }
    canvas { display:block; }

    /* UI */
    #ui {
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      justify-content:space-between;
      pointer-events:none;
      z-index:10;
    }
    #topbar{
      pointer-events:auto;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px;
      background:linear-gradient(to bottom, rgba(0,0,0,.65), rgba(0,0,0,0));
    }
    .btnLink{
      color:#fff; text-decoration:none;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      font-size:14px;
      backdrop-filter: blur(10px);
    }
    #brand{
      display:flex; align-items:center; gap:8px;
    }
    #brand img{ height:20px; width:auto; }

    #panel{
      pointer-events:auto;
      margin:0 auto 18px;
      width:min(560px, 92vw);
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      border-radius:18px;
      padding:16px;
      text-align:center;
      backdrop-filter: blur(10px);
    }
    #title{ margin:0 0 6px 0; font-weight:900; font-size:18px; }
    #steps{ margin:0 0 12px 0; font-size:13px; opacity:.85; line-height:1.45; }

    #startBtn{
      width:100%;
      border:0;
      border-radius:16px;
      padding:14px 16px;
      font-weight:900;
      font-size:16px;
      background:#fff;
      color:#111;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(0,0,0,.45);
    }

    #status{
      position:fixed;
      left:10px;
      bottom:10px;
      z-index:11;
      font-size:12px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.45);
      max-width:75vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.9;
      pointer-events:none;
    }
  </style>
</head>

<body>

  <div id="ui">
    <div id="topbar">
      <a class="btnLink" id="menuLink" href="https://www.canva.com/design/DAG9pcht0YQ/vMlVejQnQ2StmRcQqudt3Q/view?utm_content=DAG9pcht0YQ&utm_campaign=designshare&utm_medium=link2&utm_source=uniquelinks&utlId=h0d5e8121fb">
        ← Menú
      </a>

      <div id="brand">
        <span style="font-weight:900">Pruebas</span>
      </div>

      <a class="btnLink" href="https://goscalemarketing.com" target="_blank" rel="noopener">
        by <img alt="GoScale" src="https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/assets/logo/goscalemarketing-logo.png">
      </a>
    </div>

    <div id="panel">
      <p id="title">Pruebas · AR</p>
      <p id="steps">
        1) Pulsa <b>Iniciar AR</b><br>
        2) Apunta al suelo hasta ver el círculo<br>
        3) <b>Tap</b> para colocar · <b>Pinch</b> tamaño · <b>Giro 2 dedos</b> rotación
      </p>
      <button id="startBtn">Iniciar AR</button>
      <p style="margin:10px 0 0; font-size:12px; opacity:.65; line-height:1.35;">
        Android: mejor en <b>Chrome</b>. iPhone: abre <b>Quick Look</b>.
      </p>
    </div>
  </div>

  <div id="status">Listo</div>

<script type="module">
  // ====== CONFIG (las mismas URLs que ya tienes) ======
  const GLB_URL  = "https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pruebas/Pruebas.glb";
  const USDZ_URL = "https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pruebas/Pruebas.usdz";
  const MENU_URL = "https://www.canva.com/design/DAG9pcht0YQ/vMlVejQnQ2StmRcQqudt3Q/view?utm_content=DAG9pcht0YQ&utm_campaign=designshare&utm_medium=link2&utm_source=uniquelinks&utlId=h0d5e8121fb";

  document.getElementById("menuLink").href = MENU_URL;

  // ====== Detect ======
  const ua = navigator.userAgent;
  const isiOS = /iPad|iPhone|iPod/.test(ua);
  const isAndroid = /Android/.test(ua);

  const statusEl = document.getElementById("status");
  const setStatus = (t) => statusEl.textContent = t;

  const startBtn = document.getElementById("startBtn");
  const panel = document.getElementById("panel");

  function openSceneViewer() {
    const intent =
      "intent://arvr.google.com/scene-viewer/1.0" +
      "?file=" + encodeURIComponent(GLB_URL) +
      "&mode=ar_preferred" +
      "&resizable=true" +
      "#Intent;scheme=https;package=com.google.android.googlequicksearchbox;end;";
    window.location.href = intent;
  }

  // ====== Imports (Three.js) ======
  import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
  import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js";

  // ====== Three.js Scene ======
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera();

  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.0));

  // Reticle
  const reticle = new THREE.Mesh(
    new THREE.RingGeometry(0.08, 0.10, 32).rotateX(-Math.PI / 2),
    new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.9 })
  );
  reticle.matrixAutoUpdate = false;
  reticle.visible = false;
  scene.add(reticle);

  // Load model
  const loader = new GLTFLoader();
  let modelRoot = null;
  let placed = false;

  setStatus("Cargando modelo…");
  loader.load(
    GLB_URL,
    (gltf) => {
      modelRoot = gltf.scene;
      modelRoot.visible = false;
      modelRoot.scale.setScalar(1);
      scene.add(modelRoot);
      setStatus("Modelo listo. Pulsa Iniciar AR.");
    },
    undefined,
    () => setStatus("Error cargando GLB (revisa URL).")
  );

  // Controller (tap)
  const controller = renderer.xr.getController(0);
  scene.add(controller);

  controller.addEventListener("select", () => {
    if (!reticle.visible || !modelRoot) return;
    modelRoot.visible = true;
    modelRoot.position.setFromMatrixPosition(reticle.matrix);

    // Orientación inicial: solo yaw (rotación Y)
    const rot = new THREE.Quaternion().setFromRotationMatrix(reticle.matrix);
    modelRoot.quaternion.copy(rot);

    placed = true;
    setStatus("Colocado. Pinch=tamaño · Giro 2 dedos=rotación.");
  });

  // ====== Gestos custom (pinch escala + twist rotación Y) ======
  const pointers = new Map();
  let startDist = 0, startAngle = 0, startScale = 1, startYaw = 0;

  function getTwo() { return Array.from(pointers.values()).slice(0, 2); }
  function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
  function angle(a,b){ return Math.atan2(b.y-a.y, b.x-a.x); }

  function getYawRad() {
    if (!modelRoot) return 0;
    const e = new THREE.Euler().setFromQuaternion(modelRoot.quaternion, "YXZ");
    return e.y;
  }
  function setYawRad(yaw) {
    if (!modelRoot) return;
    const e = new THREE.Euler(0, yaw, 0, "YXZ");
    modelRoot.quaternion.setFromEuler(e);
  }

  function onPointerDown(e){
    pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });
    if (pointers.size === 2 && placed && modelRoot){
      const [p1,p2] = getTwo();
      startDist = dist(p1,p2);
      startAngle = angle(p1,p2);
      startScale = modelRoot.scale.x;
      startYaw = getYawRad();
    }
  }

  function onPointerMove(e){
    if (!pointers.has(e.pointerId)) return;
    pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });

    if (pointers.size === 2 && placed && modelRoot){
      e.preventDefault();
      const [p1,p2] = getTwo();
      const d = dist(p1,p2);
      const a = angle(p1,p2);

      if (startDist > 0){
        const factor = d / startDist;
        const newScale = THREE.MathUtils.clamp(startScale * factor, 0.2, 3.0);
        modelRoot.scale.setScalar(newScale);
      }

      const delta = a - startAngle;
      setYawRad(startYaw + delta);
    }
  }

  function onPointerUp(e){
    pointers.delete(e.pointerId);
    if (pointers.size < 2){ startDist = 0; startAngle = 0; }
  }

  renderer.domElement.style.touchAction = "none";
  renderer.domElement.addEventListener("pointerdown", onPointerDown, { passive:false });
  renderer.domElement.addEventListener("pointermove", onPointerMove, { passive:false });
  renderer.domElement.addEventListener("pointerup", onPointerUp, { passive:true });
  renderer.domElement.addEventListener("pointercancel", onPointerUp, { passive:true });

  // ====== WebXR hit-test ======
  let hitTestSource = null;
  let hitTestRequested = false;

  renderer.setAnimationLoop((t, frame) => {
    if (frame){
      const refSpace = renderer.xr.getReferenceSpace();

      if (!hitTestRequested){
        const session = renderer.xr.getSession();
        session.requestReferenceSpace("viewer").then((viewerSpace) => {
          session.requestHitTestSource({ space: viewerSpace }).then((src) => {
            hitTestSource = src;
          });
        });

        session.addEventListener("end", () => {
          hitTestRequested = false;
          hitTestSource = null;
          reticle.visible = false;
          placed = false;
          if (modelRoot) modelRoot.visible = false;

          // al cerrar AR volvemos a la UI
          panel.style.display = "block";
          setStatus("AR cerrado.");
        });

        hitTestRequested = true;
      }

      if (hitTestSource){
        const hits = frame.getHitTestResults(hitTestSource);
        if (hits.length){
          const pose = hits[0].getPose(refSpace);
          reticle.visible = true;
          reticle.matrix.fromArray(pose.transform.matrix);
        } else {
          reticle.visible = false;
        }
      }
    }

    renderer.render(scene, camera);
  });

  // ====== Start AR (un solo botón) ======
  async function startAR(){
    // iOS: Quick Look con gesto
    if (isiOS){
      window.location.href = USDZ_URL;
      return;
    }

    // Android: intenta WebXR; si no, Scene Viewer
    if (!navigator.xr || !window.isSecureContext){
      setStatus("WebXR no disponible. Abriendo Scene Viewer…");
      openSceneViewer();
      return;
    }

    const supported = await navigator.xr.isSessionSupported("immersive-ar").catch(() => false);
    if (!supported){
      setStatus("Este dispositivo no soporta WebXR AR. Abriendo Scene Viewer…");
      openSceneViewer();
      return;
    }

    // Inicia sesión AR
    setStatus("Iniciando WebXR AR…");
    panel.style.display = "none";

    const session = await navigator.xr.requestSession("immersive-ar", {
      requiredFeatures: ["hit-test"],
      optionalFeatures: ["dom-overlay"],
      domOverlay: { root: document.body }
    });

    await renderer.xr.setSession(session);
    setStatus("Apunta al suelo hasta ver el círculo.");
  }

  startBtn.addEventListener("click", startAR);

  window.addEventListener("resize", () => {
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>

</body>
</html>
