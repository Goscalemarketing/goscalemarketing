<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pruebas · AR</title>

  <!-- model-viewer (preview estable) -->
  <script type="module" src="https://unpkg.com/@google/model-viewer@4.1.0/dist/model-viewer.min.js"></script>

  <style>
    html, body{
      margin:0;
      height:100%;
      background:#0b0b0b;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      color:#fff;
      overflow:hidden;
    }

    header{
      position:fixed; inset:0 0 auto 0; height:56px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 12px;
      background:rgba(15,15,15,.75);
      backdrop-filter: blur(10px);
      z-index:30;
    }

    .menuBtn{
      color:#fff; text-decoration:none;
      border:1px solid rgba(255,255,255,.18);
      border-radius:10px;
      padding:8px 12px;
      font-size:14px;
      font-weight:700;
    }

    .byGoscale{
      display:flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.16);
      text-decoration:none;
      color:#fff;
      font-size:12px;
      font-weight:700;
    }
    .byGoscale img{ height:22px; width:auto; }

    main{
      position:fixed;
      inset:56px 0 0 0;
      display:flex;
      flex-direction:column;
    }

    #dishInfo{
      padding:14px 16px 10px;
      background:linear-gradient(
        to bottom,
        rgba(11,11,11,.95),
        rgba(11,11,11,.75),
        rgba(11,11,11,0)
      );
      z-index:10;
    }
    #dishTitle{ margin:0; font-size:24px; font-weight:900; }
    #dishDesc{ margin:8px 0 0; font-size:14px; color:rgba(255,255,255,.75); max-width:520px; line-height:1.45; }

    .viewerWrap{
      position:relative;
      flex:1;
      min-height:0;
    }

    model-viewer{
      width:100%;
      height:100%;
      background:#0b0b0b;
      display:block;
      touch-action: pan-y;
    }

    .arBtn{
      position:absolute;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      padding:14px 26px;
      border-radius:18px;
      font-size:16px;
      font-weight:900;
      background:#fff;
      color:#111;
      border:0;
      box-shadow:0 12px 30px rgba(0,0,0,.45);
      cursor:pointer;
      z-index:25;
    }
    .arBtn[disabled]{ opacity:.55; cursor:not-allowed; }

    #loading{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:14px;
      background:rgba(0,0,0,.75);
      z-index:24;
    }

    .spinner{
      width:44px;
      height:44px;
      border:4px solid rgba(255,255,255,.2);
      border-top:4px solid #fff;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* WebXR canvas (solo cuando entras en AR) */
    #xrCanvas{
      position:fixed;
      inset:0;
      z-index:999;
      display:none;
      touch-action:none;
    }

    #status{
      position:fixed;
      left:10px;
      bottom:10px;
      z-index:1000;
      font-size:12px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.45);
      max-width:75vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.9;
      display:none;
      pointer-events:none;
    }
  </style>
</head>

<body>

<header>
  <a class="menuBtn" href="https://www.canva.com/design/DAG9pcht0YQ/vMlVejQnQ2StmRcQqudt3Q/view?utm_content=DAG9pcht0YQ&utm_campaign=designshare&utm_medium=link2&utm_source=uniquelinks&utlId=h0d5e8121fb">
    ← Menú
  </a>

  <a class="byGoscale" href="https://goscalemarketing.com" target="_blank" rel="noopener">
    <span>by</span>
    <img src="https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/assets/logo/goscalemarketing-logo.png">
  </a>
</header>

<main id="uiMain">

  <section id="dishInfo">
    <h1 id="dishTitle">Pruebas</h1>
    <p id="dishDesc">Ingredientes: Es un elemento de pruebas.</p>
  </section>

  <div class="viewerWrap">

    <div id="loading">
      <div class="spinner"></div>
      <p id="loadingText">Cargando modelo…</p>
    </div>

    <!-- PREVIEW -->
    <model-viewer
      id="mvPreview"
      src="https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pruebas/Pruebas.glb"
      ios-src="https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pruebas/Pruebas.usdz"

      camera-controls
      interaction-prompt="none"
      loading="eager"
      reveal="auto"

      environment-image="https://modelviewer.dev/shared-assets/environments/neutral.hdr"
      tone-mapping="neutral"
      exposure="1.6"
      shadow-intensity="1"
    ></model-viewer>

    <!-- Botón AR (nuestro) -->
    <button id="startAR" class="arBtn" disabled>Ver en AR (WebXR test)</button>

  </div>
</main>

<canvas id="xrCanvas"></canvas>
<div id="status">Listo</div>

<!-- ✅ Script normal (SIN imports) para que SIEMPRE funcione el loader/botón -->
<script>
  const GLB_URL  = "https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pruebas/Pruebas.glb";
  const USDZ_URL = "https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pruebas/Pruebas.usdz";

  const ua = navigator.userAgent;
  const isiOS = /iPad|iPhone|iPod/.test(ua);

  const mv = document.getElementById('mvPreview');
  const btn = document.getElementById('startAR');
  const loading = document.getElementById('loading');
  const loadingText = document.getElementById('loadingText');

  const statusEl = document.getElementById('status');
  const setStatus = (t) => { statusEl.style.display = 'block'; statusEl.textContent = t; };

  function openSceneViewer() {
    const intent =
      "intent://arvr.google.com/scene-viewer/1.0" +
      "?file=" + encodeURIComponent(GLB_URL) +
      "&mode=ar_preferred" +
      "&resizable=true" +
      "#Intent;scheme=https;package=com.google.android.googlequicksearchbox;end;";
    window.location.href = intent;
  }

  // ✅ Si el modelo carga, quitamos loader y activamos botón
  mv.addEventListener('load', () => {
    loading.style.display = 'none';
    btn.disabled = false;
  });

  // ✅ Si hay error
  mv.addEventListener('error', () => {
    loadingText.textContent = 'Error cargando el modelo (revisa URL)';
    btn.disabled = false; // dejamos probar AR igualmente
  });

  // ✅ Seguridad: si en 8s no hay load, no bloqueamos al usuario
  setTimeout(() => {
    if (btn.disabled) {
      loadingText.textContent = 'El preview tarda. Puedes probar AR igualmente.';
      btn.disabled = false;
    }
  }, 8000);

  // Botón: iOS → Quick Look; Android → WebXR (si no, Scene Viewer)
  btn.addEventListener('click', async () => {
    if (isiOS) {
      window.location.href = USDZ_URL;
      return;
    }

    // Intentamos WebXR custom (carga librerías solo aquí)
    if (!navigator.xr || !window.isSecureContext) {
      openSceneViewer();
      return;
    }

    const ok = await navigator.xr.isSessionSupported("immersive-ar").catch(() => false);
    if (!ok) {
      openSceneViewer();
      return;
    }

    // Llamamos al módulo WebXR
    setStatus("Cargando AR WebXR…");
    window.__startWebXR__ && window.__startWebXR__();
  });
</script>

<!-- ✅ Módulo WebXR separado (solo se usa cuando pulsas) -->
<script type="module">
  const GLB_URL  = "https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pruebas/Pruebas.glb";

  const uiMain = document.getElementById('uiMain');
  const xrCanvas = document.getElementById('xrCanvas');
  const statusEl = document.getElementById('status');
  const setStatus = (t) => { statusEl.style.display = 'block'; statusEl.textContent = t; };

  function openSceneViewer() {
    const intent =
      "intent://arvr.google.com/scene-viewer/1.0" +
      "?file=" + encodeURIComponent(GLB_URL) +
      "&mode=ar_preferred" +
      "&resizable=true" +
      "#Intent;scheme=https;package=com.google.android.googlequicksearchbox;end;";
    window.location.href = intent;
  }

  async function startWebXR() {
    try {
      // Cargamos librerías SOLO ahora
      const THREE = await import("https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js");
      const { GLTFLoader } = await import("https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js");

      // Setup Three
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera();

      const renderer = new THREE.WebGLRenderer({ canvas: xrCanvas, antialias:true, alpha:true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;

      scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.0));

      const reticle = new THREE.Mesh(
        new THREE.RingGeometry(0.08, 0.10, 32).rotateX(-Math.PI/2),
        new THREE.MeshBasicMaterial({ color: 0xffffff, transparent:true, opacity:0.9 })
      );
      reticle.matrixAutoUpdate = false;
      reticle.visible = false;
      scene.add(reticle);

      // Load model
      setStatus("Cargando modelo AR…");
      const loader = new GLTFLoader();
      const modelRoot = await new Promise((resolve, reject) => {
        loader.load(GLB_URL, (gltf) => resolve(gltf.scene), undefined, reject);
      });
      modelRoot.visible = false;
      modelRoot.scale.setScalar(1);
      scene.add(modelRoot);

      // UI switch
      uiMain.style.display = "none";
      xrCanvas.style.display = "block";
      xrCanvas.style.touchAction = "none";
      setStatus("Iniciando sesión AR…");

      // Gestos (pinch escala + twist yaw)
      const pointers = new Map();
      let placed = false;
      let startDist = 0, startAngle = 0, startScale = 1, startYaw = 0;

      const getTwo = () => Array.from(pointers.values()).slice(0, 2);
      const dist = (a,b) => Math.hypot(a.x-b.x, a.y-b.y);
      const angle = (a,b) => Math.atan2(b.y-a.y, b.x-a.x);

      const getYaw = () => {
        const e = new THREE.Euler().setFromQuaternion(modelRoot.quaternion, "YXZ");
        return e.y;
      };
      const setYaw = (yaw) => {
        const e = new THREE.Euler(0, yaw, 0, "YXZ");
        modelRoot.quaternion.setFromEuler(e);
      };

      xrCanvas.addEventListener("pointerdown", (e) => {
        pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });
        if (pointers.size === 2 && placed) {
          const [p1,p2] = getTwo();
          startDist = dist(p1,p2);
          startAngle = angle(p1,p2);
          startScale = modelRoot.scale.x;
          startYaw = getYaw();
        }
      }, { passive:false });

      xrCanvas.addEventListener("pointermove", (e) => {
        if (!pointers.has(e.pointerId)) return;
        pointers.set(e.pointerId, { x:e.clientX, y:e.clientY });

        if (pointers.size === 2 && placed) {
          e.preventDefault();
          const [p1,p2] = getTwo();
          const d = dist(p1,p2);
          const a = angle(p1,p2);

          const factor = d / startDist;
          const newScale = THREE.MathUtils.clamp(startScale * factor, 0.2, 3.0);
          modelRoot.scale.setScalar(newScale);

          const delta = a - startAngle;
          setYaw(startYaw + delta);
        }
      }, { passive:false });

      const up = (e) => { pointers.delete(e.pointerId); if (pointers.size < 2) { startDist = 0; startAngle = 0; } };
      xrCanvas.addEventListener("pointerup", up, { passive:true });
      xrCanvas.addEventListener("pointercancel", up, { passive:true });

      // Controller select (tap place)
      const controller = renderer.xr.getController(0);
      scene.add(controller);

      controller.addEventListener("select", () => {
        if (!reticle.visible) return;
        modelRoot.visible = true;
        modelRoot.position.setFromMatrixPosition(reticle.matrix);
        placed = true;
        setStatus("Colocado. Pinch=tamaño · Giro 2 dedos=rotación.");
      });

      // Start session
      const session = await navigator.xr.requestSession("immersive-ar", {
        requiredFeatures: ["hit-test"]
      });
      await renderer.xr.setSession(session);
      setStatus("Apunta al suelo hasta ver el círculo.");

      let hitTestSource = null;
      let requested = false;

      renderer.setAnimationLoop((t, frame) => {
        if (frame) {
          const refSpace = renderer.xr.getReferenceSpace();

          if (!requested) {
            const s = renderer.xr.getSession();
            s.requestReferenceSpace("viewer").then((viewerSpace) => {
              s.requestHitTestSource({ space: viewerSpace }).then((src) => hitTestSource = src);
            });
            requested = true;

            s.addEventListener("end", () => {
              xrCanvas.style.display = "none";
              uiMain.style.display = "flex";
              statusEl.style.display = "none";
              reticle.visible = false;
              modelRoot.visible = false;
            });
          }

          if (hitTestSource) {
            const hits = frame.getHitTestResults(hitTestSource);
            if (hits.length) {
              const pose = hits[0].getPose(refSpace);
              reticle.visible = true;
              reticle.matrix.fromArray(pose.transform.matrix);
            } else {
              reticle.visible = false;
            }
          }
        }
        renderer.render(scene, camera);
      });

    } catch (e) {
      console.error(e);
      setStatus("WebXR falló. Abriendo Scene Viewer…");
      openSceneViewer();
    }
  }

  // Expone la función al script normal (sin imports)
  window.__startWebXR__ = startWebXR;
</script>

</body>
</html>
