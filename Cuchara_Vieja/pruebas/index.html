<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Plato en AR</title>

  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    html, body { margin:0; height:100%; background:#0b0b0b; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    header{
      position:fixed; inset:0 0 auto 0; height:56px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 12px;
      background:rgba(15,15,15,.72); backdrop-filter: blur(10px);
      color:#fff; z-index:10;
    }
    header .badge{
      font-size:12px; padding:4px 8px; border-radius:999px;
      background:rgba(255,255,255,.12);
      max-width: 55%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    header button{
      border:0; border-radius:10px;
      padding:10px 12px; font-weight:700;
      background:#fff; color:#111; cursor:pointer;
    }
    header button:disabled{ opacity:.5; cursor:not-allowed; }
    main{ position:fixed; inset:56px 0 0 0; }
    model-viewer{ width:100%; height:100%; background:#0b0b0b; }
    #toast{
      position:fixed; left:12px; right:12px; bottom:12px;
      padding:10px 12px; border-radius:12px;
      background:rgba(0,0,0,.6); color:#fff; font-size:14px;
      display:none; z-index:20;
    }
  </style>
</head>

<body>
  <header>
    <div style="font-weight:700">AR</div>
    <div id="mode" class="badge">Cargando…</div>
    <button id="arBtn" disabled>Ver en AR</button>
  </header>

  <main>
    <model-viewer
      id="mv"
      src="https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pastel_Banana_Chip/pastelbananachip.glb"
      ios-src="https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pastel_Banana_Chip/pastelbananachip.usdz"

      camera-controls
      interaction-prompt="none"
      touch-action="pan-y"

      loading="eager"
      reveal="auto"

      environment-image="neutral"
      tone-mapping="neutral"
      exposure="1.1"
      shadow-intensity="0.2"

      ar
      ar-placement="floor"
      ar-scale="fixed"
      ar-modes="webxr scene-viewer quick-look">
    </model-viewer>
  </main>

  <div id="toast"></div>

  <script>
    const mv = document.getElementById('mv');
    const arBtn = document.getElementById('arBtn');
    const mode = document.getElementById('mode');
    const toast = document.getElementById('toast');

    function show(msg, ms=2600){
      toast.textContent = msg;
      toast.style.display = 'block';
      clearTimeout(show._t);
      show._t = setTimeout(()=>toast.style.display='none', ms);
    }

    const ua = navigator.userAgent || '';
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    const isAndroid = /Android/i.test(ua);

    let chosen = null; // 'webxr' | 'scene-viewer' | 'quick-look'

    async function chooseAndForceARModes() {
      if (isIOS) {
        chosen = 'quick-look';
        // Forzamos SOLO quick-look
        mv.setAttribute('ar-modes', 'quick-look');
        mode.textContent = 'iOS → Quick Look';
        arBtn.disabled = false;
        return;
      }

      if (isAndroid) {
        try {
          const webxrOk = !!(navigator.xr && await navigator.xr.isSessionSupported('immersive-ar'));
          if (webxrOk) {
            chosen = 'webxr';
            // Forzamos SOLO webxr (evita que caiga a Scene Viewer)
            mv.setAttribute('ar-modes', 'webxr');
            mode.textContent = 'Android → WebXR (forzado)';
          } else {
            chosen = 'scene-viewer';
            // Forzamos SOLO scene-viewer
            mv.setAttribute('ar-modes', 'scene-viewer');
            mode.textContent = 'Android → Scene Viewer (fallback)';
          }
          arBtn.disabled = false;
          return;
        } catch (e) {
          chosen = 'scene-viewer';
          mv.setAttribute('ar-modes', 'scene-viewer');
          mode.textContent = 'Android → Scene Viewer (fallback)';
          arBtn.disabled = false;
          return;
        }
      }

      chosen = null;
      mode.textContent = 'AR no disponible';
      arBtn.disabled = true;
    }

    mv.addEventListener('load', async () => {
      show('Modelo cargado');
      await chooseAndForceARModes();
    });

    mv.addEventListener('error', () => {
      mode.textContent = 'Error modelo';
      show('Error cargando el modelo (URL/CORS)');
      arBtn.disabled = true;
    });

    arBtn.addEventListener('click', async () => {
      try {
        show(`Abriendo AR (${chosen || 'auto'})…`);
        await mv.activateAR();
      } catch (e) {
        show('No se pudo abrir AR');
      }
    });

    // Al volver desde Scene Viewer / Quick Look
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) show('De vuelta al viewer');
    });

    // Debug: si es WebXR y entra/sale sesión
    mv.addEventListener('ar-status', (ev) => {
      const s = ev.detail.status;
      if (s === 'session-started') show('WebXR iniciado');
      if (s === 'not-presenting') show('WebXR cerrado');
      if (s === 'failed') show('WebXR falló (fallback no se usa porque forzamos modo)');
    });
  </script>
</body>
</html>
