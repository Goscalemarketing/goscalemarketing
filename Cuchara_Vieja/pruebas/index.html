<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Plato en AR</title>

  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    html, body { margin:0; height:100%; background:#0b0b0b; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    header{
      position:fixed; inset:0 0 auto 0; height:56px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 12px;
      background:rgba(15,15,15,.72); backdrop-filter: blur(10px);
      color:#fff; z-index:10;
    }
    header .badge{
      font-size:12px; padding:4px 8px; border-radius:999px;
      background:rgba(255,255,255,.12);
      max-width:60%;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    header button{
      border:0; border-radius:10px;
      padding:10px 12px; font-weight:700;
      background:#fff; color:#111; cursor:pointer;
    }
    header button:disabled{ opacity:.5; cursor:not-allowed; }
    main{ position:fixed; inset:56px 0 0 0; }
    model-viewer{ width:100%; height:100%; background:#0b0b0b; }
    #toast{
      position:fixed; left:12px; right:12px; bottom:12px;
      padding:10px 12px; border-radius:12px;
      background:rgba(0,0,0,.6); color:#fff; font-size:14px;
      display:none; z-index:20;
    }
  </style>
</head>

<body>
  <header>
    <div style="font-weight:700">AR</div>
    <div id="mode" class="badge">Cargandoâ€¦</div>
    <button id="arBtn" disabled>Ver en AR</button>
  </header>

  <main>
    <model-viewer
      id="mv"
      src="https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pastel_Banana_Chip/pastelbananachip.glb"
      ios-src="https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pastel_Banana_Chip/pastelbananachip.usdz"

      camera-controls
      interaction-prompt="none"
      touch-action="pan-y"

      loading="eager"
      reveal="auto"

      environment-image="https://modelviewer.dev/shared-assets/environments/neutral.hdr"
      tone-mapping="neutral"
      exposure="1.6"
      shadow-intensity="1"

      ar
      ar-placement="floor"
      ar-scale="fixed"
      ar-modes="webxr scene-viewer quick-look"
      ar-light-estimation>
    </model-viewer>
  </main>

  <div id="toast"></div>

  <script>
    const mv = document.getElementById('mv');
    const arBtn = document.getElementById('arBtn');
    const mode = document.getElementById('mode');
    const toast = document.getElementById('toast');

    const ua = navigator.userAgent || '';
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    const isAndroid = /Android/i.test(ua);

    function show(msg, ms=2400){
      toast.textContent = msg;
      toast.style.display = 'block';
      clearTimeout(show._t);
      show._t = setTimeout(()=>toast.style.display='none', ms);
    }

    // âœ… Look del VIEWER (el que te funcionaba igual en Android+iOS)
    const VIEWER = {
      exposure: 1.6,
      shadow: 1.0,
      tone: 'neutral',
      env: "https://modelviewer.dev/shared-assets/environments/neutral.hdr"
    };

    // âœ… Look SOLO para AR WebXR (anti-lavado)
    // Ajusta exposure aquÃ­ si el AR sale lavado: 0.9 â†’ 0.8 â†’ 0.7
    const WEBXR_AR = {
      exposure: 0.85,
      shadow: 0.15,
      tone: 'neutral'
    };

    let chosen = null;

    function applyViewerLook(){
      mv.environmentImage = VIEWER.env;
      mv.toneMapping = VIEWER.tone;
      mv.exposure = VIEWER.exposure;
      mv.shadowIntensity = VIEWER.shadow;
    }

    function applyWebxrArLook(){
      mv.toneMapping = WEBXR_AR.tone;
      mv.exposure = WEBXR_AR.exposure;
      mv.shadowIntensity = WEBXR_AR.shadow;
    }

    async function chooseModeAndForce(){
      applyViewerLook(); // ðŸ”’ SIEMPRE dejamos el viewer como debe

      if (isIOS) {
        chosen = 'quick-look';
        mv.setAttribute('ar-modes', 'quick-look');
        mode.textContent = 'iOS â†’ Quick Look';
        arBtn.disabled = false;
        return;
      }

      if (isAndroid) {
        try {
          const webxrOk = !!(navigator.xr && await navigator.xr.isSessionSupported('immersive-ar'));
          if (webxrOk) {
            chosen = 'webxr';
            mv.setAttribute('ar-modes', 'webxr'); // forzamos WebXR
            mode.textContent = 'Android â†’ WebXR (forzado)';
          } else {
            chosen = 'scene-viewer';
            mv.setAttribute('ar-modes', 'scene-viewer');
            mode.textContent = 'Android â†’ Scene Viewer (fallback)';
          }
          arBtn.disabled = false;
          return;
        } catch (e) {
          chosen = 'scene-viewer';
          mv.setAttribute('ar-modes', 'scene-viewer');
          mode.textContent = 'Android â†’ Scene Viewer (fallback)';
          arBtn.disabled = false;
          return;
        }
      }

      chosen = null;
      mode.textContent = 'AR no disponible';
      arBtn.disabled = true;
    }

    mv.addEventListener('load', async () => {
      show('Modelo cargado');
      await chooseModeAndForce();
    });

    mv.addEventListener('error', () => {
      mode.textContent = 'Error modelo';
      show('Error cargando el modelo (URL/CORS)');
      arBtn.disabled = true;
    });

    arBtn.addEventListener('click', async () => {
      try {
        show(`Abriendo AR (${chosen || 'auto'})â€¦`);
        // â— NO tocamos look aquÃ­ â†’ asÃ­ el viewer nunca se â€œblanqueaâ€
        await mv.activateAR();
      } catch (e) {
        applyViewerLook();
        show('No se pudo abrir AR');
      }
    });

    // âœ… AquÃ­ es donde aplicamos el look AR SOLO si realmente entra en WebXR
    mv.addEventListener('ar-status', (ev) => {
      const s = ev.detail.status;
      if (s === 'session-started') {
        show('WebXR iniciado');
        applyWebxrArLook();
      }
      if (s === 'not-presenting') {
        show('De vuelta al viewer');
        applyViewerLook();
      }
      if (s === 'failed') {
        show('WebXR fallÃ³');
        applyViewerLook();
      }
    });

    // Al volver desde Quick Look / Scene Viewer (otra app)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) applyViewerLook();
    });
  </script>
</body>
</html>
