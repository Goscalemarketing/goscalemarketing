<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pruebas AR</title>

  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    html, body { margin:0; height:100%; background:#0b0b0b; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    header{
      position:fixed; inset:0 0 auto 0; height:56px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 12px;
      background:rgba(15,15,15,.72); backdrop-filter: blur(10px);
      color:#fff; z-index:10;
      gap:10px;
    }
    header .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    header .badge{
      font-size:12px; padding:4px 8px; border-radius:999px;
      background:rgba(255,255,255,.12);
      max-width: 52vw;
      overflow:hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    a.menuBtn{
      color:#fff; text-decoration:none;
      border:1px solid rgba(255,255,255,.18);
      border-radius:10px;
      padding:8px 10px;
      font-weight:600;
      font-size:14px;
      white-space:nowrap;
    }
    button.arBtn{
      border:0; border-radius:10px;
      padding:10px 12px; font-weight:800;
      background:#fff; color:#111; cursor:pointer;
      white-space:nowrap;
    }
    button.arBtn:disabled{ opacity:.5; cursor:not-allowed; }
    main{ position:fixed; inset:56px 0 0 0; }
    model-viewer{ width:100%; height:100%; background:#0b0b0b; }
  </style>
</head>

<body>
  <header>
    <div class="left">
      <a class="menuBtn" id="menuLink" href="#" target="_self">← Menú</a>
      <div id="mode" class="badge">Cargando…</div>
    </div>
    <button id="arBtn" class="arBtn" disabled>Ver en AR</button>
  </header>

  <main>
    <model-viewer
      id="mv"
      src="https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pastel_Banana_Chip/pastelbananachip.glb"
      ios-src="https://pub-83c24afb5cab45db860452e48428fdd5.r2.dev/Restaurante_Cuchara_Vieja/Pastel_Banana_Chip/pastelbananachip.usdz"

      camera-controls
      interaction-prompt="none"
      touch-action="pan-y"

      loading="eager"
      reveal="auto"

      environment-image="https://modelviewer.dev/shared-assets/environments/neutral.hdr"
      tone-mapping="neutral"
      exposure="1.6"
      shadow-intensity="1"

      ar
      ar-placement="floor"
      ar-scale="fixed"
      ar-modes="webxr scene-viewer quick-look"
      ar-light-estimation>
    </model-viewer>
  </main>

  <script>
    const MENU_URL = "https://www.canva.com/design/DAG8SYy2DPc/RVkcbBbMLHthtSRnkiUkGA/view?utm_content=DAG8SYy2DPc&utm_campaign=designshare&utm_medium=link2&utm_source=uniquelinks&utlId=h5c7aa53580";

    const mv = document.getElementById('mv');
    const arBtn = document.getElementById('arBtn');
    const mode = document.getElementById('mode');
    const menuLink = document.getElementById('menuLink');
    menuLink.href = MENU_URL;

    const ua = navigator.userAgent || '';
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    const isAndroid = /Android/i.test(ua);

    // Look estable del viewer
    const VIEWER = { exposure: 1.6, shadow: 1.0, tone: 'neutral' };
    // Look SOLO para WebXR AR (para evitar lavado en algunos Android)
    const WEBXR_AR = { exposure: 0.85, shadow: 0.15, tone: 'neutral' };

    function applyViewerLook(){
      mv.toneMapping = VIEWER.tone;
      mv.exposure = VIEWER.exposure;
      mv.shadowIntensity = VIEWER.shadow;
    }
    function applyWebxrArLook(){
      mv.toneMapping = WEBXR_AR.tone;
      mv.exposure = WEBXR_AR.exposure;
      mv.shadowIntensity = WEBXR_AR.shadow;
    }

    async function chooseMode(){
      applyViewerLook();

      if (isIOS) {
        mv.setAttribute('ar-modes', 'quick-look');
        mode.textContent = 'iOS · AR';
        arBtn.disabled = false;
        return;
      }

      if (isAndroid) {
        try {
          const webxrOk = !!(navigator.xr && await navigator.xr.isSessionSupported('immersive-ar'));
          if (webxrOk) {
            mv.setAttribute('ar-modes', 'webxr');
            mode.textContent = 'Android · WebXR';
          } else {
            mv.setAttribute('ar-modes', 'scene-viewer');
            mode.textContent = 'Android · Scene Viewer';
          }
          arBtn.disabled = false;
          return;
        } catch {
          mv.setAttribute('ar-modes', 'scene-viewer');
          mode.textContent = 'Android · Scene Viewer';
          arBtn.disabled = false;
        }
      }
    }

    mv.addEventListener('load', chooseMode);

    arBtn.addEventListener('click', async () => {
      try {
        await mv.activateAR();
      } catch {
        applyViewerLook();
      }
    });

    // Solo afecta a WebXR (no redirige a ningún sitio)
    mv.addEventListener('ar-status', (ev) => {
      if (ev.detail.status === 'session-started') applyWebxrArLook();
      if (ev.detail.status === 'not-presenting') applyViewerLook();
    });
  </script>
</body>
</html>
